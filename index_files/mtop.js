!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("mtop",this,function(){function a(){var a={},b=new p(function(b,c){a.resolve=b,a.reject=c});return a.promise=b,a}function b(a,b){for(var c in b)void 0===a[c]&&(a[c]=b[c]);return a}function c(a){var b=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]||document.firstElementChild||document;b.appendChild(a)}function d(a){var b=[];for(var c in a)a[c]&&b.push(c+"="+encodeURIComponent(a[c]));return b.join("&")}function e(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=new Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}function n(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}var o,p,q,r,s,t,u,v,w,x=[],y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(a=n(a),x=l(a),t=1732584193,u=4023233417,v=2562383102,w=271733878,o=0;o<x.length;o+=16)p=t,q=u,r=v,s=w,t=h(t,u,v,w,x[o+0],y,3614090360),w=h(w,t,u,v,x[o+1],z,3905402710),v=h(v,w,t,u,x[o+2],A,606105819),u=h(u,v,w,t,x[o+3],B,3250441966),t=h(t,u,v,w,x[o+4],y,4118548399),w=h(w,t,u,v,x[o+5],z,1200080426),v=h(v,w,t,u,x[o+6],A,2821735955),u=h(u,v,w,t,x[o+7],B,4249261313),t=h(t,u,v,w,x[o+8],y,1770035416),w=h(w,t,u,v,x[o+9],z,2336552879),v=h(v,w,t,u,x[o+10],A,4294925233),u=h(u,v,w,t,x[o+11],B,2304563134),t=h(t,u,v,w,x[o+12],y,1804603682),w=h(w,t,u,v,x[o+13],z,4254626195),v=h(v,w,t,u,x[o+14],A,2792965006),u=h(u,v,w,t,x[o+15],B,1236535329),t=i(t,u,v,w,x[o+1],C,4129170786),w=i(w,t,u,v,x[o+6],D,3225465664),v=i(v,w,t,u,x[o+11],E,643717713),u=i(u,v,w,t,x[o+0],F,3921069994),t=i(t,u,v,w,x[o+5],C,3593408605),w=i(w,t,u,v,x[o+10],D,38016083),v=i(v,w,t,u,x[o+15],E,3634488961),u=i(u,v,w,t,x[o+4],F,3889429448),t=i(t,u,v,w,x[o+9],C,568446438),w=i(w,t,u,v,x[o+14],D,3275163606),v=i(v,w,t,u,x[o+3],E,4107603335),u=i(u,v,w,t,x[o+8],F,1163531501),t=i(t,u,v,w,x[o+13],C,2850285829),w=i(w,t,u,v,x[o+2],D,4243563512),v=i(v,w,t,u,x[o+7],E,1735328473),u=i(u,v,w,t,x[o+12],F,2368359562),t=j(t,u,v,w,x[o+5],G,4294588738),w=j(w,t,u,v,x[o+8],H,2272392833),v=j(v,w,t,u,x[o+11],I,1839030562),u=j(u,v,w,t,x[o+14],J,4259657740),t=j(t,u,v,w,x[o+1],G,2763975236),w=j(w,t,u,v,x[o+4],H,1272893353),v=j(v,w,t,u,x[o+7],I,4139469664),u=j(u,v,w,t,x[o+10],J,3200236656),t=j(t,u,v,w,x[o+13],G,681279174),w=j(w,t,u,v,x[o+0],H,3936430074),v=j(v,w,t,u,x[o+3],I,3572445317),u=j(u,v,w,t,x[o+6],J,76029189),t=j(t,u,v,w,x[o+9],G,3654602809),w=j(w,t,u,v,x[o+12],H,3873151461),v=j(v,w,t,u,x[o+15],I,530742520),u=j(u,v,w,t,x[o+2],J,3299628645),t=k(t,u,v,w,x[o+0],K,4096336452),w=k(w,t,u,v,x[o+7],L,1126891415),v=k(v,w,t,u,x[o+14],M,2878612391),u=k(u,v,w,t,x[o+5],N,4237533241),t=k(t,u,v,w,x[o+12],K,1700485571),w=k(w,t,u,v,x[o+3],L,2399980690),v=k(v,w,t,u,x[o+10],M,4293915773),u=k(u,v,w,t,x[o+1],N,2240044497),t=k(t,u,v,w,x[o+8],K,1873313359),w=k(w,t,u,v,x[o+15],L,4264355552),v=k(v,w,t,u,x[o+6],M,2734768916),u=k(u,v,w,t,x[o+13],N,1309151649),t=k(t,u,v,w,x[o+4],K,4149444226),w=k(w,t,u,v,x[o+11],L,3174756917),v=k(v,w,t,u,x[o+2],M,718787259),u=k(u,v,w,t,x[o+9],N,3951481745),t=c(t,p),u=c(u,q),v=c(v,r),w=c(w,s);var O=m(t)+m(u)+m(v)+m(w);return O.toLowerCase()}function f(a,b,c){var d=c||{};document.cookie=a.replace(/[^+#$&^`|]/g,encodeURIComponent).replace("(","%28").replace(")","%29")+"="+b.replace(/[^+#$&\/:<-\[\]-}]/g,encodeURIComponent)+(d.domain?";domain="+d.domain:"")+(d.path?";path="+d.path:"")+(d.secure?";secure":"")+(d.httponly?";HttpOnly":"")}function g(a){var b=new RegExp("(?:^|;\\s*)"+a+"\\=([^;]+)(?:;\\s*|$)").exec(document.cookie);return b?b[1]:void 0}function h(a,b,c){f(a,b,c),localStorage&&(localStorage[a]=b),sessionStorage&&(sessionStorage[a]=b),window["__D_"+a+"__"]=b}function i(a){return g(a)&&decodeURIComponent(g(a))||localStorage[a]||sessionStorage[a]||window["__D_"+a+"__"]||null}function j(a){try{return".com"===a.substring(a.lastIndexOf("."))?a.substring(a.lastIndexOf(".",a.lastIndexOf(".")-1)+1):a.split(".").slice(1).join(".")}catch(b){return a.substring(a.lastIndexOf(".",a.lastIndexOf(".")-1)+1)}}function k(){var a=n.navigator.userAgent,b=a.match(/WindVane[\/\s]([\d\.\_]+)/);b&&(s.WindVaneVersion=b[1])}function l(a){this.id=++v,this.params=b(a||{},{v:"*",data:{},type:"get",dataType:"json"}),this.params.type=this.params.type.toLowerCase(),"object"==typeof this.params.data?this.sendData=JSON.stringify(this.params.data):this.sendData=this.params.data,this.middlewares=t.slice(0)}var m,n=window,o=window.lib||{},p=n.Promise;if(!p){var q="当前浏览器不支持Promise，请在windows对象上挂载Promise对象";throw m={ERROR:q},new Error(q)}var r=p.resolve(),s={},t=[],u={ERROR:-1,SUCCESS:0,TOKEN_EXPIRED:1,SESSION_EXPIRED:2},v=0;k(),l.prototype.use=function(a){if(!a)throw new Error("middleware is undefined");return this.middlewares.push(a),this},l.prototype.__processRequestType=function(a){var b=this,c=this.options;if(s.H5Request===!0&&(c.H5Request=!0),s.WindVaneRequest===!0&&(c.WindVaneRequest=!0),c.H5Request===!0?c.WindVaneRequest=!1:"undefined"==typeof c.WindVaneRequest&&"undefined"==typeof c.H5Request&&(o.windvane&&parseFloat(c.WindVaneVersion)>=5.4?c.WindVaneRequest=!0:c.H5Request=!0),c.WindVaneRequest&&(!o.windvane||parseFloat(c.WindVaneVersion)<5.4))throw new Error("WINDVANE_NOT_FOUND::缺少WindVane环境");a&&a().then(function(){var a=c.retJson.ret;return a instanceof Array&&(a=a.join(",")),c.WindVaneRequest===!0&&(!a||a.indexOf("HY_FAILED")>-1||a.indexOf("HY_NO_HANDLER")>-1||a.indexOf("HY_CLOSED")>-1||a.indexOf("HY_EXCEPTION")>-1||a.indexOf("HY_NO_PERMISSION")>-1)?(s.H5Request=!0,b.__sequence([b.__processRequestType,b.__processToken,b.__processRequestUrl,b.__loginHook,b.middlewares,b.__processRequest])):void 0})},l.prototype.__processRequestMethod=function(a){var b=this.params,c=this.options;"get"===b.type&&"jsonp"===b.dataType?c.getJSONP=!0:"get"===b.type&&"originaljsonp"===b.dataType?c.getOriginalJSONP=!0:"get"===b.type&&"json"===b.dataType?c.getJSON=!0:"post"===b.type&&(c.postJSON=!0),a()};var w="m_tk",x="m_tk_c";l.prototype.__getTokenFromCookie=function(){var a=this.options;return a.CDR&&i(x)?a.token=i(x).split(";")[0]:a.token=a.token||g(w),a.token&&(a.token=a.token.split("_")[0]),p.resolve()},l.prototype.__processToken=function(a){var b=this,c=this.options;this.params;return c.token&&delete c.token,c.WindVaneRequest!==!0?r.then(function(){return b.__getTokenFromCookie()}).then(a).then(function(){var a=c.retJson,d=a.ret;if(d instanceof Array&&(d=d.join(",")),d.indexOf("TOKEN_EMPTY")>-1||c.CDR===!0&&d.indexOf("ILLEGAL_ACCESS")>-1||d.indexOf("TOKEN_EXOIRED")>-1){if(c.H5Request&&++c.failTimes<c.maxRetryTimes)return b.__sequence([b.__processToken,b.__processRequestUrl,b.__loginHook,b.middlewares,b.__processRequest]);a.retType=u.TOKEN_EXPIRED}}):void a()},l.prototype.__processRequestUrl=function(a){var b=this.params,c=this.options;if(c.H5Request===!0){var d=b.api.toLowerCase(),f=b.v.toLowerCase(),g="//"+(b.url||c.mtopDomain)+"/h5/"+d+"/"+f+"/",h=b.appKey,i=(new Date).getTime();if(!b.url&&!c.mtopDomain)throw new Error("请设置请求地址");if(!b.appKey)throw new Error("请设置appKey");var j=e(d+"&"+f+"&"+i+"&"+h+"&"+(c.token||"")+"&"+e(""+this.sendData)),k={appKey:h,t:i,sign:j},l={data:this.sendData,ua:b.ua};Object.keys(b).forEach(function(a){"url"!=a&&"doLogin"!=a&&"undefined"==typeof k[a]&&"undefined"==typeof l[a]&&(k[a]=b[a])}),c.getJSONP?k.type="jsonp":c.getOriginalJSONP?k.type="originaljsonp":(c.getJSON||c.postJSON)&&(k.type="originaljson"),c.querystring=k,c.postdata=l,c.path=g}a()};var y=0;l.prototype.__requestJSONP=function(b){function e(a){if(k&&clearTimeout(k),l.parentNode&&l.parentNode.removeChild(l),"TIMEOUT"===a)window[j]=function(){window[j]=void 0;try{delete window[j]}catch(a){}};else{window[j]=void 0;try{delete window[j]}catch(b){}}}var f=a(),g=this.params,h=this.options,i=g.timeout||2e4,j="mtopjsonp"+(g.jsonpIncPrefix||"")+ ++y,k=setTimeout(function(){b("TIMEOUT::接口超时"),e("TIMEOUT")},i);h.querystring.callback=j;var l=document.createElement("script");return l.src=h.path+"?"+d(h.querystring)+"&"+d(h.postdata),l.async=!0,l.onerror=function(){e("ABORT"),b("ABORT::接口异常退出")},window[j]=function(){h.results=Array.prototype.slice.call(arguments),e(),f.resolve()},c(l),f.promise},l.prototype.__requestJSON=function(b){function c(a){k&&clearTimeout(k),"TIMEOUT"===a&&h.abort()}var e=a(),f=this.params,g=this.options,h=new n.XMLHttpRequest,j=f.timeout||2e4,k=setTimeout(function(){b("TIMEOUT::接口超时"),c("TIMEOUT")},j);g.CDR&&i(x)&&(g.querystring.mopen_c=i(x)),h.onreadystatechange=function(){if(4==h.readyState){var a,d,f=h.status;if(f>=200&&300>f||304==f){c(),a=h.responseText,d=h.getAllResponseHeaders()||"";try{a=/^\s*$/.test(a)?{}:JSON.parse(a),a.responseHeaders=d,g.results=[a],e.resolve()}catch(i){b("PARSE_JSON_ERROR::解析JSON失败")}}else c("ABORT"),b("ABORT::接口异常退出")}};var l,m,o=g.path+"?"+d(g.querystring);if(g.getJSON?(l="GET",o+="&"+d(g.postdata)):g.postJSON&&(l="POST",m=d(g.postdata)),h.open(l,o,!0),h.withCredentials=!0,h.setRequestHeader("Accept","application/json"),h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.headers)for(var p in f.headers)h.setRequestHeader(p,f.headers[p]);return h.send(m),e.promise},l.prototype.__requestWindVane=function(b){function c(a){i.results=[a],g.resolve()}var d,e,f,g=a(),h=this.params,i=this.options,j=this.sendData,k=h.api,l=h.v,m=i.postJSON?1:0,n=i.getJSON||i.postJSON?"originaljson":"",p="https"===location.protocol?1:0,q=h.isSec||0,r=h.sessionOption||"AutoLoginOnly";if("undefined"==typeof h.ecode)throw new Error("UNEXCEPT_PARAM_ECODE::缺少ecode参数");return d=parseInt(h.ecode),f="undefined"!=typeof h.timer?parseInt(h.timer):"undefined"!=typeof h.timeout?parseInt(h.timeout):2e4,e=2*f,o.windvane.call("MtopWVPlugin","send",{api:k,v:l,post:String(m),type:n,isHttps:String(p),ecode:String(d),isSec:String(q),param:JSON.parse(j),timer:f,sessionOption:r,ext_headers:{referer:location.href}},c,c,e),g.promise},l.prototype.__loginHook=function(a){var b=this,c=this.options,d=this.params,e=d.doLogin||c.doLogin,f=function(){return b.__sequence([b.__processToken,b.__processRequestUrl,b.__loginHook,b.middlewares,b.__processRequest])};return a().then(function(){var a=c.retJson,d=a.ret;d instanceof Array&&(d=d.join(",")),(d.indexOf("SESSION_EXPIRED")>-1||d.indexOf("SID_INVALID")>-1||d.indexOf("AUTH_REJECT")>-1||d.indexOf("NEED_LOGIN")>-1)&&(!c.WindVaneRequest&&++c.failTimes<c.maxRetryTimes?e&&e.call(b,f):a.retType=u.SESSION_EXPIRED)})},l.prototype.__processRequest=function(a,b){var c=this;return r.then(function(){var a=c.options;if(a.H5Request&&(a.getJSONP||a.getOriginalJSONP))return c.__requestJSONP(b);if(a.H5Request&&(a.getJSON||a.postJSON))return c.__requestJSON(b);if(a.WindVaneRequest)return c.__requestWindVane(b);throw new Error("UNEXCEPT_REQUEST::错误的请求类型")}).then(a).then(function(){var a=c.options,b=(c.params,a.results[0]),d=b&&b.ret||[];b.ret=d,d instanceof Array&&(d=d.join(","));var e=b.mopen_c||b.data.mopen_c;a.CDR&&e&&h(x,e,{domain:a.pageDomain,path:"/"}),d.indexOf("SUCCESS")>-1?b.retType=u.SUCCESS:b.retType=u.ERROR,a.retJson=b})},l.prototype.__sequence=function(b){function c(b){if(b instanceof Array)b.forEach(c);else{var g,h=a(),i=a();e.push(function(){return h=a(),g=b.call(d,function(a){return h.resolve(a),i.promise},function(a){return h.reject(a),i.promise}),g&&(g=g["catch"](function(a){h.reject(a)})),h.promise}),f.push(function(a){return i.resolve(a),g})}}var d=this,e=[],f=[];b.forEach(c);for(var g,h=r;g=e.shift();)h=h.then(g);for(;g=f.pop();)h=h.then(g);return h};var z=function(a){a()},A=function(a){a()};return l.prototype.request=function(a){var c=this;a.maxRetryTimes=a.maxRetryTimes||5,a.failTimes=a.failTimes||0,this.options=b(a||{},s);var d=p.resolve([z,A]).then(function(a){var b=a[0],d=a[1];return c.__sequence([b,c.__processRequestMethod,c.__processRequestType,c.__processToken,c.__processRequestUrl,c.__loginHook,c.middlewares,c.__processRequest,d])}).then(function(){var a=c.options.retJson;return a.retType!==u.SUCCESS?p.reject(a):c.options.successCallback?void c.options.successCallback(a):p.resolve(a)})["catch"](function(a){var b;return a instanceof Error?(console.error(a.stack),b={ret:[a.message],stack:[a.stack],retJson:u.ERROR}):b="string"==typeof a?{ret:[a],retJson:u.ERROR}:void 0!==a?a:c.options.retJson,c.options.failureCallback?void c.options.failureCallback(b):p.reject(b)});return this.__processRequestType(),c.options.H5Request&&(c.constructor.__firstProcessor||(c.constructor.__firstProcessor=d),z=function(a){c.constructor.__firstProcessor.then(a)["catch"](a)}),a.pageDomain=a.pageDomain||j(n.location.hostname),("get"===this.params.type&&"json"===this.params.dataType||"post"===this.params.type)&&j(a.mtopDomain)!==a.pageDomain&&(a.maxRetryTimes=4,a.CDR=!0),d},m=function(a){return new l(a)},m.request=function(a,b,c){var d={H5Request:a.H5Request,WindVaneRequest:a.WindVaneRequest,successCallback:b,failureCallback:c||b};return new l(a).request(d)},m.middlewares=t,m.config=s,m.RESPONSE_TYPE=u,m.CLASS=l,m});